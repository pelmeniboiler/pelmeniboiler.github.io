<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="translation-source" content="graflect_ipa">
    <meta name="description" content="Chart mapping the Graflect phonetic orthography to the International Phonetic Alphabet (IPA).">
    <meta name="keywords" content="Language">
    <meta name="pubDate" content="2025-06-13T10:00:00Z">
    <title>▤ Graflect to IPA chart</title>
    <link rel="stylesheet" href="/styles/pelmeni2025.css">
    <link rel="stylesheet" href="/styles/article.css">
    <style>
        /* Basic table styling for readability */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 1.1em;
        }
        th, td {
            border: var(--text-color);
            padding: 8px 12px;
            text-align: left;
        }
        .graflect-font, th:first-child {
            font-size: 1.5em; /* Make Graflect symbols larger */
            text-align: center;
        }
        td:nth-child(2) {
             font-family: 'Segoe UI', 'Arial', sans-serif; /* Use a font that supports IPA */
             text-align: center;
        }

        /* FIX: Force the FairfaxHD font on all elements with this class */
        .graflect-font {
            font-family: "FairfaxHD" !important;
        }

        body {
            max-width: 100%;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="eink-mode light-mode">

    <nav id="nav-window" class="window" style="top: 0; left: 0; min-height: fit-content; width: 260px; position: absolute; z-index: 3;">
        <div class="title-bar">
            <span class="title" data-key="win_article_nav_title">◈ article.nav</span>
            <button class="close-btn">&times;</button>
        </div>
        <div class="content">
            <h2><a href="#intro" data-key="gt_nav_h2_intro">Introduction</a></h2>
            <h3><a href="#consonants" data-key="gt_nav_h3_consonants">&ensp;Consonants</a></h3>
            <h3><a href="#vowels" data-key="gt_nav_h3_vowels">&ensp;Vowels</a></h3>
            <h3><a href="#other" data-key="gt_nav_h3_other">&ensp;Other Symbols</a></h3>
            <h2><a href="/index.html" data-key="gt_nav_h2_home">⌂←</a></h2>
        </div>
    </nav> 

    <main id="gallery-window" class="window" style="top: 0; left: 260px; right: 0; bottom: 0; position: absolute; z-index: 2;">
        <div class="title-bar">
            <span class="title" data-key="win_guide_title">▤ graflect.guide</span>
            <button class="close-btn">&times;</button>
        </div>
        <article class="content">
            <header>
                <h1 id="title" data-key="guide_h1">A Guide to Graflect & its IPA Equivalents</h1>
                <p id="intro" data-key="guide_p1"><a href="https://maycxc.github.io/prop.html">Graflect</a> is a phonetic orthography featured on Aaron Paterson's personal website, MayCXC. It is subtly featural and is capable of rendering a wide variety of accents in English and even other languages. The orthography is included in the <a href="https://www.kreativekorp.com/ucsur/">Under-ConScript Unicode Registry (<abbr title="Under-ConScript Unicode Registry">UCSUR</abbr>)</a>, and font support is available from creators like Rebecca G. Bettencourt of Kreative Korp in the <a href="https://www.kreativekorp.com/software/fonts/fairfax/">FairfaxHD</a> font (as seen on page), and in <a href="https://fontstruct.com/fontstructions/show/1961216/gs-unicode-2-0-plane-0">greenstar967's GS Unicode 2.0 font</a>. To date, no public guide mapping Graflect to the <abbr title="International Phonetic Alphabet">IPA</abbr> has been created. This chart serves as the first comprehensive resource for this purpose, created to aid in understanding and transcription.</p>
            </header>
            <section>
                <p data-key="graflect_example_p">Here is an example paragraph written in Graflect, I hope my voice comes through.<br></p>
                <aside> , . . , , , , , , . <br> .    ,    : <br> " ,    " <br>" "</aside>
            </section>
            <hr>
            <section>
                <h2 id="consonants" data-key="guide_h2_consonants">Consonants</h2>
                <table>
                    <thead>
                        <tr>
                            <th data-key="table_header_symbol">Graflect Symbol</th>
                            <th data-key="table_header_ipa">IPA Symbol</th>
                            <th data-key="table_header_example">Example Sound</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="graflect-font"></td><td>/p/</td><td data-key="example_p_in_plan"><b>p</b> in <b>p</b>lan</td></tr>
                        <tr><td class="graflect-font"></td><td>/b/</td><td data-key="example_b_in_band"><b>b</b> in <b>b</b>and</td></tr>
                        <tr><td class="graflect-font"></td><td>/t/</td><td data-key="example_t_in_tend"><b>t</b> in <b>t</b>end</td></tr>
                        <tr><td class="graflect-font"></td><td>/d/</td><td data-key="example_d_in_lend"><b>d</b> in len<b>d</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/k/</td><td data-key="example_k_in_kick"><b>k</b> in <b>k</b>ick, <b>c</b> in <b>c</b>ool</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɡ/</td><td data-key="example_g_in_gone"><b>g</b> in <b>g</b>one</td></tr>
                        <tr><td class="graflect-font"></td><td>/f/</td><td data-key="example_f_in_fail"><b>f</b> in <b>f</b>ail</td></tr>
                        <tr><td class="graflect-font"></td><td>/v/</td><td data-key="example_v_in_vine"><b>v</b> in <b>v</b>ine</td></tr>
                        <tr><td class="graflect-font"></td><td>/θ/</td><td data-key="example_th_in_think"><b>th</b> in <b>th</b>ink</td></tr>
                        <tr><td class="graflect-font"></td><td>/ð/</td><td data-key="example_th_in_this"><b>th</b> in <b>th</b>is</td></tr>
                        <tr><td class="graflect-font"></td><td>/s/</td><td data-key="example_s_in_south"><b>s</b> in <b>s</b>outh</td></tr>
                        <tr><td class="graflect-font"></td><td>/z/</td><td data-key="example_z_in_zone"><b>z</b> in <b>z</b>one</td></tr>
                        <tr><td class="graflect-font"></td><td>/ʃ/</td><td data-key="example_sh_in_shut"><b>sh</b> in <b>sh</b>ut</td></tr>
                        <tr><td class="graflect-font"></td><td>/ʒ/</td><td data-key="example_s_in_occasion"><b>s</b> in occa<b>s</b>ion</td></tr>
                        <tr><td class="graflect-font"></td><td>/h/</td><td data-key="example_h_in_home"><b>h</b> in <b>h</b>ome</td></tr>
                        <tr><td class="graflect-font"></td><td>/m/</td><td data-key="example_m_in_man"><b>m</b> in <b>m</b>an</td></tr>
                        <tr><td class="graflect-font"></td><td>/n/</td><td data-key="example_n_in_north"><b>n</b> in <b>n</b>orth</td></tr>
                        <tr><td class="graflect-font"></td><td>/ŋ/</td><td data-key="example_ng_in_long"><b>ng</b> in lo<b>ng</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/l/</td><td data-key="example_l_in_lend"><b>l</b> in <b>l</b>end</td></tr>
                        <tr><td class="graflect-font"></td><td>/r/</td><td data-key="example_r_in_rope"><b>r</b> in <b>r</b>ope (American R)</td></tr>
                        <tr><td class="graflect-font"></td><td>/w/</td><td data-key="example_w_in_woman"><b>w</b> in <b>w</b>oman</td></tr>
                        <tr><td class="graflect-font"></td><td>/j/</td><td data-key="example_y_in_your"><b>y</b> in <b>y</b>our</td></tr>
                    </tbody>
                </table>
            </section>
        
            <section>
                <h2 id="vowels" data-key="guide_h2_vowels">Vowels</h2>
                 <table>
                    <thead>
                        <tr>
                            <th data-key="table_header_symbol">Graflect Symbol</th>
                            <th data-key="table_header_ipa">IPA Symbol</th>
                            <th data-key="table_header_example">Example Sound</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="graflect-font"></td><td>/iː/</td><td data-key="example_ea_in_lean"><b>ea</b> in l<b>ea</b>n</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɪ/</td><td data-key="example_i_in_in"><b>i</b> in <b>i</b>n</td></tr>
                        <tr><td class="graflect-font"></td><td>/ʊ/</td><td data-key="example_oo_in_good"><b>oo</b> in g<b>oo</b>d</td></tr>
                        <tr><td class="graflect-font"></td><td>/u/</td><td data-key="example_oo_in_school"><b>oo</b> in sch<b>oo</b>l</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɛ/</td><td data-key="example_e_in_lend"><b>e</b> in l<b>e</b>nd</td></tr>
                        <tr><td class="graflect-font"></td><td>/æ/</td><td data-key="example_a_in_accent"><b>a</b> in <b>a</b>ccent</td></tr>
                        <tr><td class="graflect-font"></td><td>/ʌ/ or /ə/</td><td data-key="example_u_in_tug"><b>u</b> in t<b>u</b>g (also used for schwa)</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɑ/</td><td data-key="example_o_in_soft"><b>o</b> in s<b>o</b>ft</td></tr>
                        <tr><td class="graflect-font"></td><td>/eɪ/</td><td data-key="example_a_in_game"><b>a</b> in g<b>a</b>me</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɛə/</td><td data-key="example_a_in_ant"><b>a</b> in ant</td></tr>
                        <tr><td class="graflect-font"></td><td>/aɪ/</td><td data-key="example_ye_in_bye"><b>ye</b> in b<b>ye</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/aʊ/</td><td data-key="example_ou_in_south"><b>ou</b> in s<b>ou</b>th</td></tr>
                        <tr><td class="graflect-font"></td><td>/oʊ/</td><td data-key="example_o_in_home"><b>o</b> in h<b>o</b>me</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɔ/</td><td data-key="example_o_in_hole"><b>o</b> in h<b>o</b>le</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɜː/</td><td data-key="example_british_r"><b>ur</b> in n<b>ur</b>se but with a British Accent</td></tr>
                        <tr><td class="graflect-font"></td><td>/ɛər/</td><td data-key="example_air_in_air"><b>air</b> in <b>air</b></td></tr>
                    </tbody>
                </table>
            </section>

             <section>
                <h2 id="other" data-key="guide_h2_other">Other Symbols (Affricates, Non-English & Compounds)</h2>
                 <table>
                    <thead>
                        <tr>
                            <th data-key="table_header_symbol">Graflect Symbol</th>
                            <th data-key="table_header_ipa">IPA Symbol</th>
                            <th data-key="table_header_example_desc">Example Sound / Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="graflect-font"></td><td>/tʃ/</td><td data-key="example_ch_in_chase"><b>ch</b> in <b>ch</b>ase</td></tr>
                        <tr><td class="graflect-font"></td><td>/dʒ/</td><td data-key="example_j_in_jump"><b>j</b> in <b>j</b>ump</td></tr>
                        <tr><td class="graflect-font"></td><td>/ju/</td><td data-key="example_you_in_you"><b>you</b> in <b>you</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/wi/</td><td data-key="example_we_in_we"><b>we</b> in <b>we</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/ɥi/</td><td data-key="example_ui_in_huit">French: <b>ui</b> in h<b>ui</b>t</td></tr>
                        <tr><td class="graflect-font"></td><td>/x/</td><td data-key="example_ch_in_bach">German: <b>ch</b> in Ba<b>ch</b></td></tr>
                        <tr><td class="graflect-font"></td><td>/ɾ/</td><td data-key="example_r_in_rasgueado">Spanish: Flapped <b>r</b> in pe<b>r</b>o</td></tr>
                        <tr><td class="graflect-font"></td><td>/ʁ/</td><td data-key="example_re_in_kugelschreiber">German: Guttural <b>r</b> in <b>R</b>ammstein</td></tr>
                    </tbody>
                </table>
            </section>
        </article>
    </main>
    
    <div id="settings-module-placeholder"></div>
    <div id="start-menu-module-placeholder"></div>
    <div id="graflect-module-placeholder"></div>
    <script src="/scripts/module-loader.js" defer></script>
     <script>
        // --- DATA MAPPINGS ---
        const graflectMap = {
            '/p/': '', '/b/': '', '/t/': '', '/d/': '', '/k/': '', '/ɡ/': '',
            '/f/': '', '/v/': '', '/θ/': '', '/ð/': '', '/s/': '', '/z/': '',
            '/ʃ/': '', '/ʒ/': '', '/h/': '', '/m/': '', '/n/': '', '/ŋ/': '',
            '/l/': '', '/r/': '', '/w/': '', '/j/': '', '/iː/': '', '/ɪ/': '',
            '/ʊ/': '', '/u/': '', '/ɛ/': '', '/æ/': '', '/ʌ/': '', '/ə/': '',
            '/ɑ/': '', '/eɪ/': '', '/ɛə/': '', '/aɪ/': '', '/aʊ/': '', '/oʊ/': '',
            '/ɔ/': '', '/ɜː/': '', '/ɛər/': '', '/tʃ/': '', '/dʒ/': '', '/ju/': '',
            '/wi/': '', '/ɥi/': '', '/x/': '', '/ɾ/': '', '/ʁ/': '',
            '/ks/': '', '/kw/': '', '/ɒ/': '', '/uː/': '',
            '/ɔɪ/': '', '/ʃən/': '', '/ʒən/': '', '/ʃəs/': '',
            '/ʃəl/': '', '/ʒər/': '', '/ʃʊər/': '', '/tʃər/': '',
            '/sk/': '', '/səl/': '', '/ɛks/': '',
            '/ɛɡz/': '', '/ɡw/': '', '/juː/': '', '/ndʒ/': ''
        };

        const defaultWordMap = {
            'a': '', 'an': '',
            'are': '', 'as': '', 'at': '', 'be': '', 'because': '',
            'been': '', 'before': '', 'but': '', 'by': '',
            'change': '', 'come': '', 'could': '', 'day': '', 'do': '',
            'each': '', 'even': '', 'first': '', 'for': '',
            'from': '', 'get': '', 'give': '',
            'great': '', 'had': '', 'has': '', 'have': '', 'he': '',
            'her': '', 'here': '', 'him': '', 'his': '',
            'i': '', 'if': '', 'in': '', 'into': '', 'is': '', 'it': '',
            'its': '', 'just': '', 'like': '',
            'made': '', 'make': '',
            'me': '', 'more': '', 'most': '', 'my': '', 'new': '',
            'of': '', 'on': '',
            'one': '', 'only': '', 'or': '', 'other': '',
            'over': '', 'people': '', 'place': '',
            'said': '', 'same': '', 'see': '', 'she': '',
            'some': '', 'take': '', 'than': '', 'that': '', 'the': '',
            'their': '', 'them': '', 'then': '', 'there': '', 'these': '',
            'they': '', 'thing': '', 'think': '', 'this': '', 'those': '',
            'time': '', 'to': '', 'two': '', 'up': '', 'use': '',
            'very': '', 'want': '', 'was': '',
            'way': '', 'we': '', 'well': '', 'were': '',
            'when': '', 'where': '', 'which': '', 'who': '', 'why': '',
            'will': '', 'with': '', 'work': '', 'would': '', 'year': '',
            'you': '', 'your': ''
        };

        const graphemeToIpa = {
            'tious': '/ʃəs/', 'cious': '/ʃəs/', 'ssion': '/ʃən/', 'stle': '/səl/',
            'sion': ['/ʃən/', '/ʒən/'], 'tion': '/ʃən/', 'cian': '/ʃən/',
            'tial': '/ʃəl/', 'cial': '/ʃəl/', 'sure': ['/ʒər/', '/ʃʊər/'],
            'ture': '/tʃər/', 'dge': '/dʒ/', 'eigh': '/eɪ/', 'igh': '/aɪ/',
            'tch': '/tʃ/', 'age': ['/ɪdʒ/', '/eɪdʒ/'], 'ex': ['/ɛks/', '/ɛɡz/'],
            'nge': '/ndʒ/', 'que': '/k/', 'lk': '/k/', 'lm': '/m/', 'mb': '/m/', 'bt': '/t/',
            'ps': '/s/', 'pn': '/n/', 'rh': '/r/',
            'sch': ['/sk/', '/ʃ/'], 'eau': ['/oʊ/', '/juː/'],
            'sc': ['/sk/', '/s/'], 'gu': ['/ɡ/', '/ɡw/'],
            'ck': '/k/', 'qu': '/kw/', 'th': ['/θ/', '/ð/'], 'sh': '/ʃ/',
            'ch': ['/tʃ/', '/k/', '/ʃ/'], 'ng': '/ŋ/', 'ph': '/f/', 'kn': '/n/', 'wr': '/r/',
            'gh': ['/ɡ/', '/f/', ''], 'oo': ['/uː/', '/ʊ/', '/ʌ/'], 'ee': ['/iː/', '/ɪ/'],
            'ea': ['/iː/', '/ɛ/', '/eɪ/'], 'ou': ['/aʊ/', '/oʊ/', '/u/', '/ʌ/'],
            'ow': ['/aʊ/', '/oʊ/', '/u/'], 'ew': ['/ju/', '/uː/'],
            'au': '/ɔ/', 'oi': '/ɔɪ/', 'oy': '/ɔɪ/',
            'ai': ['/eɪ/', '/ɛ/'], 'ay': '/eɪ/',
            'll': '/l/', 'ss': '/s/', 'ff': '/f/', 'rr': '/r/', 'pp': '/p/', 'bb': '/b/', 
            'dd': '/d/', 'tt': '/t/', 'mm': '/m/', 'nn': '/n/',
            'a': ['/æ/', '/eɪ/', '/ɑ/', '/ə/', '/ɔ/', '/ɛə/'], 'e': ['/ɛ/', '/iː/', '/ə/', '/ɪ/', '/ɛə/'],
            'i': ['/ɪ/', '/aɪ/', '/iː/'], 'o': ['/ɒ/', '/oʊ/', '/ʌ/', '/u/', '/ɔ/'], 
            'u': ['/ʌ/', '/u/', '/ʊ/', '/ju/'], 'y': ['/ɪ/', '/aɪ/', '/iː/'],
            's': ['/s/', '/z/'], 'g': ['/ɡ/', '/dʒ/'], 'c': ['/k/', '/s/'], 'x': ['/ks/', '/z/'],
            'p': '/p/', 'b': '/b/', 't': '/t/', 'd': '/d/', 'k': '/k/', 'f': '/f/',
            'v': '/v/', 'z': '/z/', 'h': '/h/', 'm': '/m/', 'n': '/n/', 'l': '/l/',
            'r': '/r/', 'w': '/w/', 'j': '/dʒ/'
        };
        
        const diagnosticParagraph = "I know that he and she will not go, but we can see what they do. So, all people have a time to find their own way. If you look for it, you may also get more than you think. This one man had a good day; his work was about to make a change. These other people came out from the house to use the long road and go down to the water. How did he know? It was the first time they had been over there. I will give him a call now.";

        // --- DOM ELEMENTS ---
        const inputEl = document.getElementById('english-input');
        const outputEl = document.getElementById('output');
        const transliterateBtn = document.getElementById('transliterate-btn');
        const diagnosticBtn = document.getElementById('diagnostic-btn');
        const manageDictBtn = document.getElementById('manage-dict-btn');
        const activeDictNameEl = document.getElementById('active-dict-name');
        
        // Modals
        const dictionaryManagerModal = document.getElementById('dictionary-manager-modal');
        const wordEditorModal = document.getElementById('word-editor-modal');
        const closeModalManagerBtn = document.getElementById('close-manager-btn');
        const closeWordEditorBtn = document.getElementById('close-editor-btn');
        const dictionaryListEl = document.getElementById('dictionary-list');
        const wordListEl = document.getElementById('word-list');
        const wordEditorTitleEl = document.getElementById('word-editor-title');
        const newDictBtn = document.getElementById('new-dict-btn');
        const importInput = document.getElementById('import-input');

        const notificationEl = document.getElementById('notification');
        const promptAreaEl = document.getElementById('prompt-area');
        const promptHeadingEl = promptAreaEl.querySelector('#prompt-heading');
        const promptInstructionEl = promptAreaEl.querySelector('#prompt-instruction');
        const promptButtonsEl = promptAreaEl.querySelector('#prompt-buttons-container');
        const rememberCheckbox = promptAreaEl.querySelector('#remember-choice-checkbox');
        const promptWordCheckboxEl = promptAreaEl.querySelector('#prompt-word-for-checkbox');
        const directGraflectInput = promptAreaEl.querySelector('#direct-graflect-input');
        const useDirectInputBtn = promptAreaEl.querySelector('#use-direct-input-btn');
        const closePromptBtn = promptAreaEl.querySelector('#close-prompt-btn');

        // --- STATE ---
        let dictionaries = [];
        let activeDictionaryIndex = 0;
        let currentResolve;
        const graphemeKeys = Object.keys(graphemeToIpa).sort((a, b) => b.length - a.length);
        const ipaKeys = Object.keys(graflectMap).sort((a, b) => b.length - a.length);

        // --- FUNCTIONS ---

        function showNotification(message, isError = false) {
            // This function would ideally use a proper notification element from the parent page
            console.log(`Notification: ${message}`);
            alert(message);
        }

        function getActiveDictionary() {
            return dictionaries[activeDictionaryIndex];
        }

        function loadDictionaries() {
            const storedDicts = localStorage.getItem('graflectDictionaries');
            const storedIndex = localStorage.getItem('graflectActiveDictIndex');

            if (storedDicts) {
                dictionaries = JSON.parse(storedDicts);
                activeDictionaryIndex = storedIndex ? parseInt(storedIndex, 10) : 0;
            } else {
                dictionaries = [{
                    name: "Wendy's Accent",
                    author: "Wendy",
                    description: "Default dictionary with common English words.",
                    words: { ...defaultWordMap }
                }];
                activeDictionaryIndex = 0;
            }
            updateActiveDictDisplay();
            saveAllDictionaries();
        }

        function saveAllDictionaries() {
            localStorage.setItem('graflectDictionaries', JSON.stringify(dictionaries));
            localStorage.setItem('graflectActiveDictIndex', activeDictionaryIndex);
        }
        
        function updateActiveDictDisplay() {
            const activeDict = getActiveDictionary();
            if (activeDict) {
                activeDictNameEl.textContent = activeDict.name;
            }
        }

        function ipaToGraflect(ipaString) {
            if (!ipaString) return '';
            let result = '';
            let remainingIpa = ipaString;
            while (remainingIpa.length > 0) {
                let foundMatch = false;
                for (const key of ipaKeys) {
                    if (remainingIpa.startsWith(key)) {
                        result += graflectMap[key];
                        remainingIpa = remainingIpa.substring(key.length);
                        foundMatch = true;
                        break;
                    }
                }
                if (!foundMatch) {
                    result += remainingIpa[0];
                    remainingIpa = remainingIpa.substring(1);
                }
            }
            return result;
        }

        function findLongestGrapheme(text) {
            for (const key of graphemeKeys) {
                if (text.startsWith(key)) return key;
            }
            return text[0];
        }

        async function promptForChoice(word, grapheme, options, index) {
            transliterateBtn.disabled = true;
            const highlightedWord = `${word.substring(0, index)}<span class="prompt-word-highlight">${word.substring(index, index + grapheme.length)}</span>${word.substring(index + grapheme.length)}`;
            promptHeadingEl.innerHTML = `Ambiguity in "${word}"`;
            promptInstructionEl.innerHTML = `Choose the sound for the highlighted part: ${highlightedWord}`;
            promptWordCheckboxEl.textContent = word;
            promptButtonsEl.innerHTML = '';
            directGraflectInput.value = '';

            const allOptions = [...options, '']; 

            allOptions.forEach(ipa => {
                if (ipa === undefined) return;
                const button = document.createElement('button');
                button.className = 'normal-btn';
                const graflectChars = ipaToGraflect(ipa);
                button.innerHTML = ipa ? `${ipa} → ${graflectChars}` : 'Silent → (nothing)';
                button.onclick = () => {
                    if (currentResolve) {
                        currentResolve({ type: 'ipa', value: ipa });
                        currentResolve = null;
                    }
                    promptAreaEl.classList.add('hidden');
                    transliterateBtn.disabled = false;
                };
                promptButtonsEl.appendChild(button);
            });

            useDirectInputBtn.onclick = () => {
                 if (currentResolve) {
                    currentResolve({ type: 'direct', value: directGraflectInput.value });
                    currentResolve = null;
                }
                promptAreaEl.classList.add('hidden');
                transliterateBtn.disabled = false;
            };

            promptAreaEl.classList.remove('hidden');
            return new Promise(resolve => {
                currentResolve = resolve;
            });
        }

        async function processWord(word) {
            const lowerWord = word.toLowerCase();
            const activeDict = getActiveDictionary();

            if (activeDict && activeDict.words[lowerWord]) {
                return activeDict.words[lowerWord];
            }
            
            let finalGraflect = '';
            let remaining = lowerWord;
            let originalIndex = 0;

            while (remaining.length > 0) {
                const grapheme = findLongestGrapheme(remaining);
                const ipaOptions = graphemeToIpa[grapheme];

                if (typeof ipaOptions === 'string') {
                    finalGraflect += ipaToGraflect(ipaOptions);
                } else if (Array.isArray(ipaOptions)) {
                    const choice = await promptForChoice(word, grapheme, ipaOptions, originalIndex);
                    let segmentGraflect = '';
                    if (choice.type === 'ipa') {
                        segmentGraflect = ipaToGraflect(choice.value);
                    } else { 
                        segmentGraflect = choice.value;
                    }
                    finalGraflect += segmentGraflect;
                } else {
                    finalGraflect += grapheme;
                }
                remaining = remaining.substring(grapheme.length);
                originalIndex += grapheme.length;
            }

            if (rememberCheckbox.checked && promptAreaEl.classList.contains('hidden')) {
                activeDict.words[lowerWord] = finalGraflect;
                saveAllDictionaries();
            }
            return finalGraflect;
        }

        async function handleTransliterateClick() {
            transliterateBtn.disabled = true;
            transliterateBtn.textContent = "Processing...";
            outputEl.textContent = '';
            const text = inputEl.value;
            const parts = text.split(/(\s+|[.,!?;:"()'-])/g);
            let finalOutput = '';

            for (const part of parts) {
                if (!part) continue;
                if (part.match(/(\s+|[.,!?;:"()'-]|\d+)/)) {
                    finalOutput += part;
                } else {
                    const word = part;
                    const graflectWord = await processWord(word);
                    finalOutput += graflectWord;
                }
                outputEl.textContent = finalOutput;
            }
            
            transliterateBtn.disabled = false;
            transliterateBtn.textContent = "Transliterate";
        }

        function handleExportClick(dictIndex) {
            const dictionary = dictionaries[dictIndex];
            const dictionaryString = JSON.stringify(dictionary, null, 2);
            const blob = new Blob([dictionaryString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${dictionary.name.replace(/\s+/g, '_')}_graflect.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Dictionary "${dictionary.name}" exported!`);
        }

        function handleImportChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedDict = JSON.parse(e.target.result);
                    if (typeof importedDict !== 'object' || !importedDict.name || !importedDict.words) {
                        throw new Error("Invalid format. File must be a valid dictionary object.");
                    }
                    dictionaries.push(importedDict);
                    saveAllDictionaries();
                    populateDictionaryManager();
                    showNotification(`Dictionary "${importedDict.name}" imported successfully!`);
                } catch (error) {
                    showNotification("Error: Could not import file. " + error.message, true);
                } finally {
                    importInput.value = '';
                }
            };
            reader.readAsText(file);
        }
        
        function handleDiagnosticClick() {
            inputEl.value = diagnosticParagraph;
            showNotification("Diagnostic paragraph inserted.");
        }

        function openDictionaryManager() {
            populateDictionaryManager();
            dictionaryManagerModal.classList.remove('hidden');
        }

        function populateDictionaryManager() {
            dictionaryListEl.innerHTML = '';
            dictionaries.forEach((dict, index) => {
                const li = document.createElement('li');
                const infoDiv = document.createElement('div');
                infoDiv.className = 'dict-info';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = dict.name + (index === activeDictionaryIndex ? ' (Active)' : '');

                const authorSpan = document.createElement('span');
                authorSpan.className = 'author';
                authorSpan.textContent = `by ${dict.author}`;

                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(authorSpan);
                
                const buttonDiv = document.createElement('div');
                
                const selectBtn = document.createElement('button');
                selectBtn.textContent = 'Select';
                selectBtn.className = 'dict-btn select normal-btn';
                selectBtn.disabled = index === activeDictionaryIndex;
                selectBtn.onclick = () => {
                    activeDictionaryIndex = index;
                    saveAllDictionaries();
                    updateActiveDictDisplay();
                    populateDictionaryManager();
                    showNotification(`"${dict.name}" is now the active dictionary.`);
                };

                const exportBtn = document.createElement('button');
                exportBtn.textContent = 'Export';
                exportBtn.className = 'dict-btn normal-btn';
                exportBtn.onclick = () => handleExportClick(index);

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'dict-btn normal-btn';
                editBtn.onclick = () => openWordEditor(index);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'dict-btn delete normal-btn';
                deleteBtn.onclick = () => {
                    if (dictionaries.length <= 1) {
                        showNotification("Cannot delete the last dictionary.", true);
                        return;
                    }
                    if (confirm(`Are you sure you want to delete the "${dict.name}" dictionary? This cannot be undone.`)) {
                        dictionaries.splice(index, 1);
                        if (activeDictionaryIndex >= index) {
                            activeDictionaryIndex = Math.max(0, activeDictionaryIndex - 1);
                        }
                        saveAllDictionaries();
                        updateActiveDictDisplay();
                        populateDictionaryManager();
                    }
                };

                buttonDiv.appendChild(selectBtn);
                buttonDiv.appendChild(exportBtn);
                buttonDiv.appendChild(editBtn);
                buttonDiv.appendChild(deleteBtn);
                
                li.appendChild(infoDiv);
                li.appendChild(buttonDiv);
                dictionaryListEl.appendChild(li);
            });
        }
        
        function createNewDictionary() {
            const name = prompt("Enter a name for your new dictionary:");
            if (!name) return;

            const author = prompt("Enter your name (Author):");
            if (!author) return;

            const newDict = {
                name: name,
                author: author,
                description: "",
                words: {}
            };
            dictionaries.push(newDict);
            activeDictionaryIndex = dictionaries.length - 1;
            saveAllDictionaries();
            updateActiveDictDisplay();
            populateDictionaryManager();
            showNotification(`Created and selected new dictionary: "${name}"`);
        }

        function openWordEditor(dictIndex) {
            wordEditorTitleEl.textContent = `Editing: ${dictionaries[dictIndex].name}`;
            wordListEl.innerHTML = '';
            
            const sortedWords = Object.keys(dictionaries[dictIndex].words).sort();
            sortedWords.forEach(word => {
                const li = document.createElement('li');
                const wordSpan = document.createElement('span');
                wordSpan.className = 'dictionary-word';
                wordSpan.textContent = word;

                const graflectSpan = document.createElement('span');
                graflectSpan.className = 'dictionary-graflect';
                graflectSpan.textContent = dictionaries[dictIndex].words[word];

                const editBtn = document.createElement('button');
                editBtn.className = 'dict-btn edit normal-btn';
                editBtn.textContent = 'Edit';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'dict-btn remove normal-btn';
                removeBtn.textContent = 'Remove';
                
                const textDiv = document.createElement('div');
                textDiv.style.display = 'flex';
                textDiv.style.gap = '1em';
                textDiv.style.alignItems = 'center';
                textDiv.appendChild(wordSpan);
                textDiv.appendChild(graflectSpan);

                const buttonDiv = document.createElement('div');
                buttonDiv.appendChild(editBtn);
                buttonDiv.appendChild(removeBtn);

                li.appendChild(textDiv);
                li.appendChild(buttonDiv);
                wordListEl.appendChild(li);

                removeBtn.onclick = () => {
                    delete dictionaries[dictIndex].words[word];
                    saveAllDictionaries();
                    li.remove();
                    showNotification(`'${word}' removed.`);
                };

                editBtn.onclick = () => {
                    textDiv.innerHTML = '';
                    const wordLabel = document.createElement('span');
                    wordLabel.className = 'dictionary-word';
                    wordLabel.textContent = word;

                    const editInput = document.createElement('input');
                    editInput.type = 'text';
                    editInput.className = 'dict-edit-input';
                    editInput.value = dictionaries[dictIndex].words[word];
                    
                    textDiv.appendChild(wordLabel);
                    textDiv.appendChild(editInput);
                    editInput.focus();

                    buttonDiv.innerHTML = '';
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'dict-btn save normal-btn';
                    saveBtn.textContent = 'Save';
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'dict-btn normal-btn';
                    cancelBtn.textContent = 'Cancel';

                    buttonDiv.appendChild(saveBtn);
                    buttonDiv.appendChild(cancelBtn);

                    saveBtn.onclick = () => {
                        dictionaries[dictIndex].words[word] = editInput.value;
                        saveAllDictionaries();
                        openWordEditor(dictIndex); // Refresh list
                        showNotification(`'${word}' updated.`);
                    };
                    cancelBtn.onclick = () => {
                        openWordEditor(dictIndex); // Refresh list
                    };
                };
            });

            dictionaryManagerModal.classList.add('hidden');
            wordEditorModal.classList.remove('hidden');
        }

        // --- EVENT LISTENERS ---
        transliterateBtn.addEventListener('click', handleTransliterateClick);
        diagnosticBtn.addEventListener('click', handleDiagnosticClick);
        manageDictBtn.addEventListener('click', openDictionaryManager);
        newDictBtn.addEventListener('click', createNewDictionary);
        importInput.addEventListener('change', handleImportChange);

        closeModalManagerBtn.addEventListener('click', () => dictionaryManagerModal.classList.add('hidden'));
        closeWordEditorBtn.addEventListener('click', () => {
            wordEditorModal.classList.add('hidden');
            openDictionaryManager();
        });
        closePromptBtn.addEventListener('click', () => {
            promptAreaEl.classList.add('hidden');
            transliterateBtn.disabled = false;
        });
        
        // --- INITIALIZATION ---
        loadDictionaries();
    </script>
    
</body>
</html>