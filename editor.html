<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Custom Page Builder</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; background-color: #fdfdfd; }
        #editor-container { flex-grow: 1; }
        #toolbar { margin-bottom: 10px; display: flex; flex-direction: column; gap: 15px; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 8px;}
        #toolbar .tool-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center;}
        #toolbar button { background-color: #efefef; border: 1px solid #ccc; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: 500;}
        #toolbar button:hover { background-color: #e0e0e0; }
        #export-button { background-color: #4CAF50; color: white; border: none; grid-column: 1 / -1; font-weight: bold; }
        #export-button:hover { background-color: #45a049; }
        #editor { border: 1px solid #ccc; padding: 15px; min-height: 500px; background: #fff; border-radius: 8px; }
        #editor aside { border-left: 3px solid #ccc; padding-left: 10px; margin: 1em 0; color: #555; }
        #preview-container { width: 300px; flex-shrink: 0; }
        #nav-preview { background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-height: 200px; }
        #page-name-input { border: 1px solid #ccc; padding: 5px; border-radius: 5px; }
        h1, h2, h3 { margin-top: 1.5em; color: #333; }
        hr { border: none; border-top: 1px solid #eee; margin: 1em 0; }
        kbd { background-color: #eee; border: 1px solid #b4b4b4; border-radius: 3px; box-shadow: 0 1px 1px rgba(0,0,0,.2), 0 2px 0 0 rgba(255,255,255,.7) inset; color: #333; display: inline-block; font-family: monospace; font-size: .85em; font-weight: 700; line-height: 1; padding: 2px 4px; white-space: nowrap; }
    </style>
</head>
<body>

    <div id="editor-container">
        <h1>Page Content Editor</h1>
        <div id="toolbar">
             <div class="tool-group">
                <label for="page-name-input"><strong>Page Name / Translation Source:</strong></label>
                <input type="text" id="page-name-input" placeholder="e.g., my-cool-article">
            </div>
            <div class="tool-group">
                <button onclick="document.execCommand('formatBlock', false, 'h2');">Heading 2</button>
                <button onclick="document.execCommand('formatBlock', false, 'p');">Paragraph</button>
                <button onclick="addImage();">Image</button>
                <button onclick="document.execCommand('insertHorizontalRule', false);">Divider</button>
            </div>
            <div class="tool-group">
                <button onclick="document.execCommand('italic', false);"><i>Italic</i></button>
                <button onclick="document.execCommand('underline', false);"><u>Underline</u></button>
                <button onclick="document.execCommand('strikeThrough', false);"><del>Strikethrough</del></button>
                <button onclick="addLink();">üîó Link</button>
            </div>
            <div class="tool-group">
                <button onclick="wrapSelection('code');"><code>Code</code></button>
                <button onclick="wrapSelection('kbd');"><kbd>Keyboard</kbd></button>
                <button onclick="wrapSelection('dfn');">Definition</button>
                <button onclick="addAbbr();">Abbr.</button>
            </div>
            <div class="tool-group">
                <button onclick="document.execCommand('insertUnorderedList', false);">‚óè Unordered List</button>
                <button onclick="document.execCommand('insertOrderedList', false);">1. Ordered List</button>
                <button onclick="addDetailsBlock();">‚ñ∏ Details Block</button>
                <button onclick="wrapSelection('aside');">Aside</button>
            </div>
             <hr>
            <div class="tool-group">
                <button id="export-button" onclick="generateAndExport();">Generate & Download Page</button>
            </div>
        </div>
        <div id="editor" contenteditable="true">
            <h2>This is my first heading</h2>
            <p>This is a paragraph under the first heading. Select text and use the buttons to format it.</p>
            <h2>Here is another major section</h2>
            <p>This will become another item in the navigation menu.</p>
        </div>
    </div>

    <div id="preview-container">
        <h3>Live Navigation Preview</h3>
        <div id="nav-preview"></div>
    </div>


    <script>
        const editor = document.getElementById('editor');
        const navPreview = document.getElementById('nav-preview');

        // --- STATIC HTML BLOCKS ---
        const SETTINGS_WINDOW_HTML = `
    <!-- Unified Settings Window (Starts Closed) -->
    <div id="settings-main-window" class="window settings-window init-closed" style="top: 25%; left: 25%; width: 50%; max-width: 600px; height: 400px; z-index: 11;">
        <div class="title-bar">
            <span class="title" data-key="win_settings_title">üõ† system.settings</span>
            <button class="close-btn">&times;</button>
        </div>
        <div class="settings-container">
            <nav class="settings-nav">
                <ul>
                    <li data-target="language" class="active" data-key="settings_nav_lang">Language</li>
                    <li data-target="theme" data-key="settings_nav_theme">Appearance</li>
                    <li data-target="info" data-key="settings_nav_info">Information</li>
                </ul>
            </nav>
            <main class="settings-content">
                <!-- Language Page -->
                <div id="settings-page-language" class="settings-page active">
                    <h3 data-key="lang_select_label">Select Language</h3>
                    <select id="language-select" class="dropdown">
                        <option value="en">English</option>
                        <option value="he">◊¢◊ë◊®◊ô◊™ (Hebrew)</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                        <option value="de">Deutsch (German)</option>
                        <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                    </select>
                </div>
                <!-- Appearance Page -->
                <div id="settings-page-theme" class="settings-page">
                    <h3 data-key="theme_title">Display Theme</h3>
                    <div class="setting-group-inline">
                        <input type="checkbox" id="eink-toggle" class="checkbox">
                        <label for="eink-toggle" data-key="theme_eink_label">E-Ink Mode</label>
                    </div>
                    <hr class="setting-divider">
                    <div class="setting-group">
                        <label class="radio-label"><input type="radio" name="theme" value="light" data-key="theme_light_label"> Light</label>
                        <label class="radio-label"><input type="radio" name="theme" value="dark" data-key="theme_dark_label"> Dark</label>
                        <label class="radio-label"><input type="radio" name="theme" value="funky" data-key="theme_funky_label"> Funky</label>
                    </div>
                </div>
                <!-- Information Page -->
                <div id="settings-page-info" class="settings-page">
                    <h3 data-key="info_title">Copyright & Licensing</h3>
                    <p data-key="info_p1">All photographic works...</p>
                    <p data-key="info_p2">Reproduction, distribution...</p>
                    <p data-key="info_p3">All other content...</p>
                    <p data-key="info_p4">Font...</p>
                </div>
            </main>
        </div>
    </div>`;
        const START_MENU_HTML = `
    <div class="start-menu">
        <div class="start-button">
            <img src="shzh.svg" id="start-menu-logo" alt="logo"/>
            <span data-key="start_menu_btn">program.launcher</span>
        </div>
        <ul class="window-list"></ul>
    </div>`;
        const SCRIPTS_HTML = `
    <!-- Scripts -->
    <script src="settings.js" defer><\/script>
    <script src="start menu.js" defer><\/script>`;

        // --- TOOLBAR FUNCTIONS ---
        editor.addEventListener('input', updateNavPreview);

        function addImage() { const url = prompt("Enter image URL:"); if (url) { document.execCommand('insertImage', false, url); } }
        function addLink() { const url = prompt("Enter the URL:"); if (url) { document.execCommand('createLink', false, url); } }

        function wrapSelection(tagName) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                const range = selection.getRangeAt(0);
                const wrapper = document.createElement(tagName);
                wrapper.appendChild(range.extractContents());
                range.insertNode(wrapper);
                selection.removeAllRanges(); // Deselect
            }
        }
        
        function addAbbr() {
            const title = prompt("Enter the full text for the abbreviation:");
            if (title) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                    const range = selection.getRangeAt(0);
                    const abbr = document.createElement('abbr');
                    abbr.title = title;
                    abbr.appendChild(range.extractContents());
                    range.insertNode(abbr);
                    selection.removeAllRanges();
                }
            }
        }

        function addDetailsBlock() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                const summaryText = prompt("Enter the summary for the details block:", "Click to expand");
                if (summaryText) {
                    const range = selection.getRangeAt(0);
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.textContent = summaryText;
                    details.appendChild(summary);
                    details.appendChild(range.extractContents());
                    range.insertNode(details);
                    selection.removeAllRanges();
                }
            } else {
                alert("Please select the text you want to be inside the details block.");
            }
        }
        
        // --- PREVIEW AND EXPORT LOGIC ---
        function updateNavPreview() {
            let navHtml = '<h2><a href="#">Article Sections</a></h2>\n<ul>';
            const headings = editor.querySelectorAll('h2, h3');
            headings.forEach(h => {
                const text = h.textContent || 'Untitled Heading';
                const indent = h.tagName === 'H3' ? '&emsp;&emsp;' : '&ensp;';
                navHtml += `\n  <li><a href="#">${indent}${text}</a></li>`;
            });
            navHtml += '\n</ul>\n<h2><a href="index.html">‚åÇ‚Üê</a></h2>';
            navPreview.innerHTML = navHtml;
        }

        function createManifestFromEditor() {
            const manifest = [];
            editor.childNodes.forEach(el => {
                const nodeType = el.nodeName.toLowerCase();
                let item = null;
                switch (nodeType) {
                    case 'h2': case 'h3': case 'p': case 'ul': case 'ol': case 'details': case 'hr': case 'aside':
                        item = { type: nodeType, content: el.innerHTML };
                        break;
                    case 'img':
                        item = { type: 'img', src: el.src, alt: el.alt };
                        break;
                    case 'div': // Handle contenteditable wrapping things in divs
                        manifest.push({ type: 'p', content: el.innerHTML });
                        break;
                    case '#text':
                        if (el.textContent.trim() !== '') {
                             manifest.push({ type: 'p', content: el.textContent });
                        }
                        break;
                }
                if (item) manifest.push(item);
            });
            return manifest;
        }

        function renderHtmlFromManifest(pageName, manifest) {
            let articleHtml = '';
            let navHtml = '<h2><a href="#">Article Sections</a></h2>\n<ul>';
            let h_count = 0, p_count = 0, img_count = 0;

            manifest.forEach(item => {
                const { type, content, src, alt } = item;
                let id = '', dataKey = '';
                
                if (type === 'h2' || type === 'h3') {
                    h_count++;
                    const cleanContent = item.content.replace(/<[^>]*>?/gm, '').trim();
                    id = (cleanContent.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-')) || `${type}-${h_count}`;
                    dataKey = `nav_${type}_${id}`;
                    articleHtml += `<${type} id="${id}" data-key="${dataKey}">${content}</${type}>\n`;
                    const indent = type === 'h3' ? '&emsp;&emsp;' : '&ensp;';
                    navHtml += `\n  <li><a href="#${id}">${indent}${cleanContent}</a></li>`;
                } else if (type === 'p') {
                    p_count++; dataKey = `article_p_${p_count}`;
                    articleHtml += `<p data-key="${dataKey}">${content}</p>\n`;
                } else if (type === 'img') {
                    img_count++; dataKey = `article_img_${img_count}`;
                    articleHtml += `<img src="${src}" alt="${alt || ''}" data-key="${dataKey}" class="article-image">\n`;
                } else if (['ul', 'ol', 'details', 'aside'].includes(type)) {
                    articleHtml += `<${type}>${content}</${type}>\n`;
                } else if (type === 'hr') {
                     articleHtml += `<hr>\n`;
                }
            });
            
            navHtml += '\n</ul>\n<h2><a href="index.html">‚åÇ‚Üê</a></h2>';

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="translation-source" content="${pageName}">
    <title>${pageName}</title>
    <link rel="stylesheet" href="pelmeni2025.css">
    <link rel="stylesheet" href="article.css">
</head>
<body class="eink-mode light-mode">
    <nav id="nav-window" class="window" style="top: 0; left: 0; width: 260px; height: fit-content; position: absolute; z-index: 3;">
        <div class="title-bar"><span class="title">‚óà ${pageName}.nav</span></div>
        <div class="content">${navHtml}</div>
    </nav>
    <main id="gallery-window" class="window" style="top: 0; left: 260px; right: 0; bottom: 0; position: absolute; z-index: 2;">
        <div class="title-bar"><span class="title">‚ñ§ ${pageName}.article</span></div>
        <article class="content">${articleHtml}</article>
    </main>
    ${SETTINGS_WINDOW_HTML}
    ${START_MENU_HTML}
    ${SCRIPTS_HTML}
</body>
</html>`;
        }
        
        function generateAndExport() {
            const pageNameInput = document.getElementById('page-name-input');
            const pageName = pageNameInput.value.trim() || 'untitled-page';
            const manifest = createManifestFromEditor();
            const fileContent = renderHtmlFromManifest(pageName, manifest);
            const blob = new Blob([fileContent], { type: 'text/html;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${pageName}.html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // Initial nav generation
        updateNavPreview();
    </script>
</body>
</html>
